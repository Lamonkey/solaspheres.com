// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                   @id @default(cuid())
  email                  String                   @unique
  hashedPassword         String
  role                   UserRole                 @default(CLIENT)
  firstName              String?
  lastName               String?
  timezone               String?
  phoneNumber            String?
  active                 Boolean                  @default(true)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  practitionerProfile    PractitionerProfile?
  clientProfile          ClientProfile?
  appointmentsAsClient   Appointment[]            @relation("ClientAppointments")
  appointmentsAsProvider Appointment[]            @relation("PractitionerAppointments")
  sessionMessages        SessionMessage[]
  memberships            OrganizationMembership[]
  monitoringStreams      MonitoringStream[]
}

model PractitionerProfile {
  id                  String                         @id @default(cuid())
  userId              String                         @unique
  licenseNumber       String
  npi                 String?
  verificationStatus  PractitionerVerificationStatus @default(PENDING)
  specialties         String[]
  yearsExperience     Int?
  bio                 String?
  onboardingCompleted Boolean                        @default(false)
  createdAt           DateTime                       @default(now())
  updatedAt           DateTime                       @updatedAt
  user                User                           @relation(fields: [userId], references: [id], onDelete: Cascade)
  availabilitySlots   AvailabilitySlot[]
}

model ClientProfile {
  id         String   @id @default(cuid())
  userId     String   @unique
  dateOfBirth DateTime?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Organization {
  id            String                  @id @default(cuid())
  name          String
  slug          String                  @unique
  contactEmail  String
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  memberships   OrganizationMembership[]
  appointments  Appointment[]
  monitoring    MonitoringStream[]
}

model OrganizationMembership {
  id             String           @id @default(cuid())
  organizationId String
  userId         String
  role           OrganizationRole @default(MEMBER)
  createdAt      DateTime         @default(now())
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
}

model Appointment {
  id                String            @id @default(cuid())
  practitionerId    String
  clientId          String
  organizationId    String?
  mode              AppointmentMode   @default(LIVE)
  status            AppointmentStatus @default(PENDING)
  startTime         DateTime
  endTime           DateTime
  asyncWindowEndsAt DateTime?
  notes             String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  practitioner      User              @relation("PractitionerAppointments", fields: [practitionerId], references: [id])
  client            User              @relation("ClientAppointments", fields: [clientId], references: [id])
  organization      Organization?     @relation(fields: [organizationId], references: [id])
  messages          SessionMessage[]
}

model SessionMessage {
  id            String             @id @default(cuid())
  appointmentId String
  senderId      String
  messageType   SessionMessageType @default(TEXT)
  content       String
  attachmentUrl String?
  createdAt     DateTime           @default(now())
  appointment   Appointment        @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  sender        User               @relation(fields: [senderId], references: [id], onDelete: Cascade)
}

model AvailabilitySlot {
  id                    String               @id @default(cuid())
  practitionerProfileId String
  startsAt              DateTime
  endsAt                DateTime
  isRecurring           Boolean              @default(false)
  weekday               Int?
  createdAt             DateTime             @default(now())
  practitionerProfile   PractitionerProfile  @relation(fields: [practitionerProfileId], references: [id], onDelete: Cascade)
}

model MonitoringStream {
  id            String                 @id @default(cuid())
  organizationId String
  userId        String?
  streamType    MonitoringStreamType   @default(VITALS)
  status        MonitoringStreamStatus @default(ACTIVE)
  deviceLabel   String?
  lastReadingAt DateTime?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  organization  Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user          User?                  @relation(fields: [userId], references: [id], onDelete: SetNull)
  readings      MonitoringReading[]
}

model MonitoringReading {
  id          String   @id @default(cuid())
  streamId    String
  collectedAt DateTime
  payload     Json
  createdAt   DateTime @default(now())
  stream      MonitoringStream @relation(fields: [streamId], references: [id], onDelete: Cascade)
}

enum UserRole {
  CLIENT
  PRACTITIONER
  ADMIN
}

enum PractitionerVerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrganizationRole {
  MEMBER
  MANAGER
  OWNER
}

enum AppointmentMode {
  LIVE
  ASYNC
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELED
  NO_SHOW
}

enum SessionMessageType {
  TEXT
  AUDIO
  FILE
  FORM
}

enum MonitoringStreamType {
  VITALS
  ACTIVITY
  SLEEP
  CUSTOM
}

enum MonitoringStreamStatus {
  ACTIVE
  PAUSED
  STOPPED
}
